------------------------------------------------------
title: FODNUTs: Fixed-Output Derivations for Network-Utilizing Tests
summary: Using fixed-output derivation to run tests that access the network
tags: nixos
draft: false
------------------------------------------------------

Nix provides two main types of derivations:

1. normal derivations
2. fixed-output derivations (FODs)

The big difference is that fixed-output derivations allow you to access the
internet from within the Nix build sandbox.  However they require you to give the
hash of the derivation output in advance.

Aside from some [exotic use-cases](https://github.com/cdepillabout/evil-nix),
fixed-output derivations are generally used to download files from the
internet.  Here's an example of a fixed-output derivation you may be familiar
with:

```nix
fetchurl {
  url = "http://www.example.org/hello-1.0.tar.gz";
  sha256 = "0v6r3wwnsk5pdjr188nip3pjgn1jrn5pc5ajpcfy6had6b3v4dwm";
}
```

This derivation will download the tarball
`http://www.example.org/hello-1.0.tar.gz`.  Note that this tarball has to have
the sha256 hash `0v6r3wwnsk5pdjr188nip3pjgn1jrn5pc5ajpcfy6had6b3v4dwm`, or the
derivation will fail to build.

Aside from downloading files from the internet, there is one other good use of
fixed-output derivations: running a test (or a whole test-suite) that needs
access to the internet.  In this article I'll refer to these types of
derivations as _fixed-output derivations for network-utilizing tests_
(**FODNUTs**).

Here's an example of a FODNUT: imagine you're writing a derivation to build
`curl`.  After building `curl`, you want to test that `curl` works correctly.
The obvious way to do this is to try to download a file from the internet using
`curl`.  However, in a normal derivation, you can't access the internet.  One
way to work around this is to create a separate fixed-output derivation, and
run the `curl` tests in that.  If the test fail, then you can just make the
derivation fail during the build.  If the tests pass, then the derivation
should cleanly build.

If you're familiar with Nix, you'll immediately see two big problems here:

1.  FODs require the derivation output to be hashed.  But in this example, what
    should we output?  And what will its hash be?
2.  Normally, FODs don't get rebuilt unless the output of their hash changes.

## Conclusion

## Footnotes
