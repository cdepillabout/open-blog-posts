------------------------------------------------------
title: binplz: easily curl static binaries
summary: Introducing binplz, a service that serves curl-able statically-linked binaries from Nixpkgs
tags: nixos
draft: false
------------------------------------------------------

[Nixery](https://nixery.dev/) is an interesting service. It dynamically serves
Docker images created from arbitrary packages from Nixpkgs.

I thought that a similar type of service could be created that serves
statically-linked binaries from Nixpkgs.  This would be another way for users
on any Linux distro to benefit from all the software packaged in Nixpkgs.  I
explained this to my friends [Jonas Carpay](https://jonascarpay.com/)
([@jonascarpay](https://github.com/jonascarpay)) and Hideaki Kawai
([@kayhide](https://github.com/kayhide)), and we came up with the name
`binplz.dev`.  I was thinking that the service would work like the following.

Imagine you're on your Linux machine, and you realize you need the `tree` command.
Normally you could install it with your package manager, but maybe your package manager
is broken.  (Or maybe you don't want `tree`, but you want some package that isn't
available on your distro.)

You should be able to download a statically-linked `tree` binary from `binplz.dev`:

```console
$ curl binplz.dev/tree > tree
$ chmod +x ./tree
```

You can then use this tree binary like you'd expect:

```console
$ ./tree --version
tree v1.8.0 (c) 1996 - 2018 by Steve Baker, ...
```

You can confirm that this tree binary is statically linked:

```console
$ file ./tree
./tree: ELF 64-bit LSB executable, x86-64, version 1 (SYSV), statically linked, not stripped
```

The "statically linked" part of the output of file signifies that this binary
is statically linked.

Behind the scenes, when you access a URL like `binplz.dev/tree`, the web server
running on `binplz.dev` builds the derivation
[`pkgsStatic.tree`](https://functor.tokyo/blog/2021-10-20-nix-cross-static) from
Nixpkgs, pulls out the statically-linked `bin/tree` binary from the output, and
returns it.

`binplz.dev` should be able to build and serve any package from Nixpkgs.[^2]

## Writing binplz

Jonas and Hideaki joined me to build an initial version of binplz.  We created a
[binplz repo](https://github.com/binplz/binplz.dev/) to hold our code,
and Jonas quickly put together an initial implementation.

The initial implementation did everything we required above, but our next task
was getting it deployed.

## Problems

When trying to work out how to deploy this service, we ran into a few
problems.

When a user requests a binary like `tree`, binplz is going to have to build it
at least once, since the Nixpkgs Hydra doesn't build and cache most things from
`pkgsStatic`.  Most of our problems revolved around the following:

1.  Where do we do the actually building?  A single build machine on AWS or
    Hetzner might work, but it would be slow if a bunch of users request
    derivations like Chromium and Firefox.  Auto-scaling might be better, but
    it could get really expensive.[^1]

2.  Where do we store the build outputs?  An S3 cache is an obvious choice, but
    the store could get really expensive in certain cases.

    For instance, if we allow users to build binaries from any arbitrary
    Nixpkgs commit, our stores could blow up to tens or hundreds of terrabytes.
    Or, what if there happens to be some sort of dynamic attr path in Nixpkgs a
    user could use to keep building different derivations?

3.  We probably need some sort of caching when builds fail, so that we don't
    retry them. For instance, we don't want to repeatedly try to rebuild a huge
    piece of software like PyTorch if we know it will always fail halfway
    through.

    This leads to a few interesting follow-up problems, like how do you tell
    an actual build failure from a transient network problem, or hardware
    problem?

None of these problems are insurmountable, but we all sort of lost interest
before we implemented solutions to each of them.

If you're interested in more discussion on each of these, check out the
[issue tracker](https://github.com/binplz/binplz.dev/issues).

## Still a Good Idea

I still think a service like binplz is a neat idea.  It would really show off
the flexibility and power of Nix and Nixpkgs.  It would be a useful service if
you need a certain binary in a pinch.  There are a bunch of different directions
you could take it in to do other cool things.

I hope someone decides to pick up this idea and drive it to completion!

## Footnotes

[^1]: We were seriously considering using [nixbuild.net](https://nixbuild.net/)
    for this.

[^2]: Well, any package that makes sense to build and link statically.
